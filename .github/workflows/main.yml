name: Delete Failed Workflow Runs

on:
  workflow_dispatch:  # Manuelle Ausf√ºhrung erlaubt

jobs:
  delete_failed_runs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up GitHub CLI
        run: |
          curl -s https://raw.githubusercontent.com/cli/cli/trunk/script/install.sh | bash
          gh auth login --with-token < ${GITHUB_TOKEN}

      - name: List all workflow runs and delete failed ones
        run: |
          # Get the list of all workflow runs in the repository
          runs=$(gh api repos/${{ github.repository }}/actions/runs -q '.workflow_runs[] | select(.status=="failure") | .id')

          # Loop through the failed runs and delete them
          if [ -z "$runs" ]; then
            echo "No failed runs found."
          else
            for run_id in $runs; do
              echo "Deleting failed workflow run with ID: $run_id"
              gh api repos/${{ github.repository }}/actions/runs/$run_id/attempts --method DELETE
            done
          fi
